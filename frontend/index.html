
<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Stock Forecast Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.3.0/dist/chart.umd.min.js"></script>
    <link href="style.css" rel="stylesheet">
  </head>
  <body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
      <div class="container-fluid">
        <a class="navbar-brand" href="#">Stock Forecast</a>
        <div class="collapse navbar-collapse">
          <ul class="navbar-nav me-auto">
            <li class="nav-item"><a class="nav-link active" href="#">Dashboard</a></li>
          </ul>
        </div>
      </div>
    </nav>

    <main class="container my-4">
      <div class="row align-items-end mb-3">
        <div class="col-md-3">
          <label class="form-label">Ticker</label>
          <input id="ticker" class="form-control" value="AAPL" />
        </div>
        <div class="col-md-3">
          <label class="form-label">Start Date</label>
          <input id="startDate" type="date" class="form-control" />
        </div>
        <div class="col-md-3">
          <label class="form-label">End Date</label>
          <input id="endDate" type="date" class="form-control" />
        </div>
        <div class="col-md-3 text-end">
          <label class="form-label">&nbsp;</label>
          <div>
            <button id="loadBtn" class="btn btn-primary">Load Data</button>
            <button id="downloadCsv" class="btn btn-outline-primary">Download CSV</button>
          </div>
        </div>
      </div>

      <div class="row g-3 mb-4">
        <div class="col-md-4">
          <div class="card p-3">
            <h6>Latest Predicted Close</h6>
            <h2 id="latestPred">--</h2>
            <small id="latestDate" class="text-muted"></small>
          </div>
        </div>
        <div class="col-md-4">
          <div class="card p-3">
            <h6>Average Predicted</h6>
            <h2 id="avgPred">--</h2>
            <small class="text-muted">over the selected range</small>
          </div>
        </div>
        <div class="col-md-4">
          <div class="card p-3">
            <h6>Sentiment Snapshot</h6>
            <ul id="sentList" class="list-unstyled mb-0"></ul>
          </div>
        </div>
      </div>

      <div class="card mb-4 p-3">
        <canvas id="predChart" height="100"></canvas>
      </div>

      <div class="card">
        <div class="card-body">
          <table id="predTable" class="table table-striped">
            <thead>
              <tr><th>Date</th><th>Predicted Close</th></tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>

      <footer class="mt-4 text-center text-muted">
        Built with Flask + Chart.js + Bootstrap
      </footer>
    </main>

    <script>
      const API_BASE = "/api";
      const API_KEY = ""; // If using API key, put it here or include in requests.

      async function fetchPredictions(ticker, start, end) {
        const params = new URLSearchParams({ ticker });
        if (start) params.set("start", start);
        if (end) params.set("end", end);
        // include api_key as query param if set
        if (API_KEY) params.set("api_key", API_KEY);
        const res = await fetch(`${API_BASE}/predictions?` + params.toString(), { headers: API_KEY?{"x-api-key":API_KEY}:{}} );
        if (res.status === 401) throw new Error("Unauthorized - provide API key");
        return res.json();
      }

      async function fetchSentiment(ticker, start, end) {
        const params = new URLSearchParams();
        if (ticker) params.set("ticker", ticker);
        if (start) params.set("start", start);
        if (end) params.set("end", end);
        if (API_KEY) params.set("api_key", API_KEY);
        const res = await fetch(`${API_BASE}/sentiment?` + params.toString(), { headers: API_KEY?{"x-api-key":API_KEY}:{}} );
        if (res.status === 401) throw new Error("Unauthorized - provide API key");
        return res.json();
      }

      let chart = null;

      function renderTable(predictions) {
        const tbody = document.querySelector("#predTable tbody");
        tbody.innerHTML = "";
        let sum = 0;
        predictions.forEach((r) => {
          const tr = document.createElement("tr");
          tr.innerHTML = `<td>${r.Date}</td><td>${Number(r.PredictedClose).toFixed(2)}</td>`;
          tbody.appendChild(tr);
          sum += Number(r.PredictedClose);
        });
        const avg = (predictions.length>0)?(sum/predictions.length):0;
        document.getElementById("avgPred").innerText = avg.toFixed(2);
        if (predictions.length>0) {
          const last = predictions[predictions.length-1];
          document.getElementById("latestPred").innerText = Number(last.PredictedClose).toFixed(2);
          document.getElementById("latestDate").innerText = last.Date;
        } else {
          document.getElementById("latestPred").innerText = "--";
          document.getElementById("latestDate").innerText = "";
        }
      }

      function renderChart(predictions, sentimentDaily) {
        const ctx = document.getElementById("predChart").getContext("2d");
        const labels = predictions.map(p => p.Date);
        const data = predictions.map(p => Number(p.PredictedClose));
        const sentiment = sentimentDaily.map(s => ({x: s.Date, y: Number(s.sentiment)}));
        if (chart) chart.destroy();
        chart = new Chart(ctx, {
          type: 'line',
          data: {
            labels,
            datasets: [
              { label: 'Predicted Close', data, tension: 0.3, fill: false, borderWidth: 2 },
              { label: 'Daily Sentiment (scaled)', data: sentiment.map(s=>s.y*100), type: 'bar', backgroundColor: 'rgba(0,0,0,0.05)' }
            ]
          },
          options: {
            scales: {
              y: { beginAtZero: false }
            },
            interaction: { mode: 'index', intersect: false },
          }
        });
      }

      async function loadAndRender() {
        const ticker = document.getElementById("ticker").value || "AAPL";
        const start = document.getElementById("startDate").value || null;
        const end = document.getElementById("endDate").value || null;
        try {
          const [preds, sent] = await Promise.all([
            fetchPredictions(ticker, start, end),
            fetchSentiment(ticker, start, end)
          ]);
          renderTable(preds);
          renderChart(preds, sent);
          // sentiment list
          const list = document.getElementById("sentList");
          list.innerHTML = "";
          if (Array.isArray(sent) && sent.length>0) {
            const avg = (sent.reduce((s,x)=>s+Number(x.sentiment),0)/sent.length).toFixed(3);
            const count = sent.reduce((s,x)=>s+Number(x.count||0),0);
            const li1 = document.createElement("li");
            li1.innerHTML = `<strong>Average Sentiment:</strong> ${avg}`;
            const li2 = document.createElement("li");
            li2.innerHTML = `<strong>Data Points:</strong> ${count}`;
            list.appendChild(li1);
            list.appendChild(li2);
          } else {
            list.innerHTML = "<li>No sentiment data</li>";
          }
        } catch (e) {
          alert("Error loading data: " + e.message);
        }
      }

      document.getElementById("loadBtn").addEventListener("click", loadAndRender);
      document.getElementById("downloadCsv").addEventListener("click", async () => {
        const ticker = document.getElementById("ticker").value || "AAPL";
        const start = document.getElementById("startDate").value || "";
        const end = document.getElementById("endDate").value || "";
        const res = await fetchPredictions(ticker, start, end);
        let csv = "Date,PredictedClose\n";
        res.forEach(r => csv += `${r.Date},${r.PredictedClose}\n`);
        const blob = new Blob([csv], {type: "text/csv"});
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url; a.download = `predictions_${ticker}.csv`; a.click();
        URL.revokeObjectURL(url);
      });

      // load default on page load
      window.addEventListener("DOMContentLoaded", () => {
        loadAndRender();
      });
    </script>
  </body>
</html>
